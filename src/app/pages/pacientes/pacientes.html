<div class="page-layout">
    <!-- Shared Sidebar -->
    <app-sidebar [activeMenu]="'pacientes'"></app-sidebar>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div class="header-left">
                <h1>Pacientes</h1>
                <p class="header-subtitle">Gestione los pacientes registrados en el sistema</p>
            </div>
            <button class="btn-primary" (click)="openCreateModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Nuevo paciente
            </button>
        </header>

        <!-- Search Bar -->
        <div class="search-bar animate-fadeIn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" placeholder="Buscar por nombre, cédula o enfermedad crónica..." [(ngModel)]="searchTerm"
                (input)="onSearch()" />
        </div>

        <!-- Skeleton Loading State -->
        <section class="patients-grid animate-fadeIn" *ngIf="loading()">
            <div class="skeleton-patient-card" *ngFor="let i of [1,2,3,4,5,6]">
                <div class="skeleton skeleton-patient-avatar"></div>
                <div class="skeleton-patient-info">
                    <div class="skeleton skeleton-text" style="width: 70%;"></div>
                    <div class="skeleton skeleton-text-sm" style="width: 50%;"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <div class="skeleton skeleton-text-sm" style="width: 50px;"></div>
                        <div class="skeleton skeleton-text-sm" style="width: 60px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Patients Grid -->
        <section class="patients-grid animate-fadeIn" *ngIf="!loading()">
            <!-- Empty State -->
            <div class="empty-state" *ngIf="filteredPacientes().length === 0">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <line x1="17" y1="11" x2="23" y2="11" />
                </svg>
                <h3>No hay pacientes</h3>
                <p>{{ searchTerm ? 'No se encontraron resultados para su búsqueda.' : 'Comience registrando su primer
                    paciente.' }}</p>
                <button class="btn-primary" (click)="openCreateModal()" *ngIf="!searchTerm">
                    Registrar paciente
                </button>
            </div>

            <!-- Patient Cards -->
            <div class="patient-card" *ngFor="let p of filteredPacientes()">
                <div class="patient-avatar">
                    {{ p.nombreEncriptado?.charAt(0)?.toUpperCase() || 'P' }}
                </div>
                <div class="patient-info">
                    <h3 class="patient-name">{{ p.nombreEncriptado || 'Sin nombre' }}</h3>
                    <p class="patient-cedula">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="16" rx="2" />
                            <line x1="7" y1="8" x2="17" y2="8" />
                            <line x1="7" y1="12" x2="13" y2="12" />
                        </svg>
                        {{ p.cedula || 'Sin cédula' }}
                    </p>
                    <div class="patient-details">
                        <span *ngIf="p.edad" class="detail-chip">{{ p.edad }} años</span>
                        <span *ngIf="p.genero" class="detail-chip">{{ p.genero }}</span>
                        <span *ngIf="p.enfermedadCronica" class="detail-chip condition">{{ p.enfermedadCronica }}</span>
                    </div>
                </div>
                <div class="patient-actions">
                    <button class="action-btn" title="Editar" (click)="openEditModal(p)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                    </button>
                    <button class="action-btn danger" title="Desasociar" (click)="desasociarPaciente(p)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
        <div class="modal-content animate-fadeIn" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ modalMode === 'create' ? 'Nuevo paciente' : 'Editar paciente' }}</h2>
                <button class="close-btn" (click)="closeModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>

            <form class="modal-form" (ngSubmit)="onSubmitForm()">
                <!-- Cedula field with auto-search -->
                <div class="form-group">
                    <label for="formCedula">Cédula de identidad *</label>
                    <div class="input-with-status">
                        <input type="text" id="formCedula" [(ngModel)]="formCedula" name="formCedula"
                            placeholder="0123456789" (blur)="onCedulaBlur()" [disabled]="modalMode === 'edit'"
                            maxlength="10" pattern="[0-9]{10}" inputmode="numeric" (keypress)="onCedulaKeyPress($event)"
                            required />
                        <span class="input-status" *ngIf="searchingCedula">
                            <span class="spinner-sm"></span>
                        </span>
                    </div>
                    <span class="form-hint" *ngIf="modalMode === 'create'">
                        Al ingresar la cédula, buscaremos si el paciente ya existe
                    </span>
                </div>

                <!-- Existing patient alert -->
                <div class="info-alert" *ngIf="existingPatient && modalMode === 'create'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="16" x2="12" y2="12" />
                        <line x1="12" y1="8" x2="12.01" y2="8" />
                    </svg>
                    <div class="alert-content">
                        <strong>Paciente encontrado</strong>
                        <p>{{ existingPatient.nombreEncriptado }} ya está registrado en el sistema. Al guardar, se
                            asociará a su
                            cuenta.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="formNombre">Nombre completo *</label>
                    <input type="text" id="formNombre" [(ngModel)]="formNombre" name="formNombre"
                        placeholder="Juan Pérez" [disabled]="existingPatient !== null"
                        pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+" (keypress)="onNombreKeyPress($event)" required />
                </div>



                <div class="form-row">
                    <div class="form-group">
                        <label for="formEdad">Edad</label>
                        <input type="number" id="formEdad" [(ngModel)]="formEdad" name="formEdad" placeholder="35"
                            min="0" max="150" [disabled]="existingPatient !== null" />
                    </div>
                    <div class="form-group">
                        <label for="formGenero">Género</label>
                        <select id="formGenero" [(ngModel)]="formGenero" name="formGenero"
                            [disabled]="existingPatient !== null">
                            <option value="">Seleccione...</option>
                            <option *ngFor="let g of generos" [value]="g">{{ g }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formTipoSangre">Tipo Sangre</label>
                        <select id="formTipoSangre" [(ngModel)]="formTipoSangre" name="formTipoSangre"
                            [disabled]="existingPatient !== null">
                            <option value="">...</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="formOcupacion">Ocupación</label>
                    <input type="text" id="formOcupacion" [(ngModel)]="formOcupacion" name="formOcupacion"
                        placeholder="Ingeniero, Estudiante, etc." [disabled]="existingPatient !== null" />
                </div>

                <div class="form-group">
                    <label>Alergias</label>
                    <div class="chips-container" [class.disabled]="existingPatient !== null">
                        <div class="chip" *ngFor="let alergia of alergiasSeleccionadas()">
                            <span>{{ alergia }}</span>
                            <button type="button" class="chip-remove" (click)="removeAlergia(alergia)"
                                *ngIf="!existingPatient">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-trigger-wrapper">
                            <input type="text" placeholder="Añadir alergia..." [(ngModel)]="alergiaSearchTerm"
                                name="alergiaSearch" (focus)="showAlergiasDropdown = true"
                                [disabled]="existingPatient !== null" autocomplete="off" />

                            <div class="dropdown-options animate-fadeIn"
                                *ngIf="showAlergiasDropdown && filteredAlergias().length > 0">
                                <div class="dropdown-option" *ngFor="let alergia of filteredAlergias()"
                                    (click)="addAlergia(alergia)">
                                    {{ alergia }}
                                </div>
                            </div>
                            <div class="dropdown-overlay" *ngIf="showAlergiasDropdown"
                                (click)="showAlergiasDropdown = false"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Antecedentes Familiares</label>
                    <div class="chips-container" [class.disabled]="existingPatient !== null">
                        <div class="chip" *ngFor="let antecedente of antecedentesSeleccionados()">
                            <span>{{ antecedente }}</span>
                            <button type="button" class="chip-remove" (click)="removeAntecedente(antecedente)"
                                *ngIf="!existingPatient">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-trigger-wrapper">
                            <input type="text" placeholder="Añadir antecedente..." [ngModel]="antecedentesSearchTerm()"
                                (ngModelChange)="antecedentesSearchTerm.set($event)" name="antecedentesSearch"
                                (focus)="showAntecedentesDropdown = true" [disabled]="existingPatient !== null"
                                autocomplete="off" />

                            <div class="dropdown-options animate-fadeIn"
                                *ngIf="showAntecedentesDropdown && filteredAntecedentes().length > 0">
                                <div class="dropdown-option" *ngFor="let antecedente of filteredAntecedentes()"
                                    (click)="addAntecedente(antecedente.nombre)">
                                    {{ antecedente.nombre }}
                                </div>
                            </div>
                            <div class="dropdown-overlay" *ngIf="showAntecedentesDropdown"
                                (click)="showAntecedentesDropdown = false"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Enfermedades crónicas</label>

                    <!-- Chips Container -->
                    <div class="chips-container" [class.disabled]="existingPatient !== null">
                        <div class="chip" *ngFor="let enfermedad of enfermedadesSeleccionadas()">
                            <span>{{ enfermedad }}</span>
                            <button type="button" class="chip-remove" (click)="removeEnfermedad(enfermedad)"
                                *ngIf="!existingPatient">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>

                        <div class="dropdown-trigger-wrapper">
                            <input type="text" placeholder="Añadir enfermedad..." [ngModel]="enfermedadSearchTerm()"
                                (ngModelChange)="enfermedadSearchTerm.set($event)" name="enfermedadSearch"
                                (focus)="showEnfermedadesDropdown = true" [disabled]="existingPatient !== null"
                                autocomplete="off" />

                            <!-- Dropdown List -->
                            <div class="dropdown-options animate-fadeIn"
                                *ngIf="showEnfermedadesDropdown && filteredEnfermedades().length > 0">
                                <div class="dropdown-option" *ngFor="let enfermedad of filteredEnfermedades()"
                                    (click)="addEnfermedad(enfermedad.nombre)">
                                    {{ enfermedad.nombre }}
                                </div>
                            </div>
                            <div class="dropdown-overlay" *ngIf="showEnfermedadesDropdown"
                                (click)="showEnfermedadesDropdown = false"></div>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div class="success-message" *ngIf="formSuccess">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    {{ formSuccess }}
                </div>
                <div class="error-message" *ngIf="formError">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                    {{ formError }}
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary" [disabled]="formLoading">
                        <span *ngIf="!formLoading">
                            {{ existingPatient ? 'Asociar paciente' : (modalMode === 'create' ? 'Registrar' :
                            'Guardar')
                            }}
                        </span>
                        <span *ngIf="formLoading" class="loading-inline">
                            <span class="spinner-sm"></span>
                            Guardando...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>